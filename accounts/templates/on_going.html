{% extends 'base.html' %}
{% load interest_tags %}
{% block content %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 mt-5">
                <div class="card">
                    <div class="card-header text-white" style="background-color: #4bb8c2;">
                        <h5 class="text-center">On Going Projects</h5>
                    </div>
                    <div class="card-body">
                        {% for post in posts %}
                            <div class="card mb-3">
                                <a href="{% url 'posts' post.id %}">
                                    <div class="card-header">{{ post.title }}</div>
                                </a>
                                <div class="card-footer">
                                    {% if user.is_authenticated %}
                                        {% if user in post.interested_users.all %}
                                            <p class="text-success">You have shown interest in this post.</p>
                                        {% else %}
                                            <button class="btn btn-primary" onclick="expressInterest({{ post.id }})" data-express-url="{% url 'express_interest' post.id %}">Interested</button>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted">Please log in to express interest.</p>
                                    {% endif %}
                                    <div id="interest-notification-{{ post.id }}"></div>  <!-- Interest notification placeholder -->
                                    <p>Published on {{ post.published_on|date:'F d, Y' }} by {{ post.uploaded_by }}</p>
                                </div>
                            </div>
                        {% empty %}
                            <p>No posts yet!</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

   <script>
    function expressInterest(postId) {
        // Send AJAX request to express interest
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/express-interest/' + postId + '/');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function () {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    document.getElementById('interest-notification-' + postId).innerHTML = '<p class="text-success">Interested</p>';
                    // Hide the "Interested" button by removing it from the DOM
                    const button = document.getElementById('interest-btn-' + postId);
                    button.parentNode.removeChild(button);

                    // Update the notification count on the bell icon
                    const notificationCountElement = document.getElementById('notification-count');
                    const currentCount = parseInt(notificationCountElement.textContent);
                    notificationCountElement.textContent = currentCount + 1;
                } else {
                    document.getElementById('interest-notification-' + postId).innerHTML = '<p class="text-danger">Error showing interest.</p>';
                }
            } else {
                document.getElementById('interest-notification-' + postId).innerHTML = '<p class="text-danger">Error showing interest.</p>';
            }
        };
        xhr.send(JSON.stringify({ post_id: postId }));
    }
</script>

{% endblock %}
